# Settings in the [build] context are global and are applied to all contexts
# unless otherwise overridden by more specific contexts.
[build]
  # Directory to change to before starting a build.
  # This is where we will look for package.json/.nvmrc/etc.
  # base = "project/"

  # Directory that contains the deploy-ready HTML files and assets generated by
  # the build. This is relative to the base directory if one has been set, or the
  # root directory if a base has not been set. This sample publishes the
  # directory located at the absolute path "root/project/build-output"
  publish = "build/"

  # Default build command.
  command = "ci/install.sh && ci/build.sh"

# Configure functions - increase timeout for image processing
[functions]
  node_bundler = "esbuild"
  included_files = ["static/assets/**"]

# Add headers for social media crawlers
[[headers]]
  for = "/*"
  [headers.values]
    X-Frame-Options = "DENY"
    X-XSS-Protection = "1; mode=block"
    X-Content-Type-Options = "nosniff"
    Referrer-Policy = "strict-origin-when-cross-origin"
    X-Robots-Tag = "index, follow"
    Cache-Control = "public, max-age=3600"

# Add specific headers for OG images to ensure they load properly
[[headers]]
  for = "/assets/media/*"
  [headers.values]
    Cache-Control = "public, max-age=86400"

[[headers]]
  for = "/assets/og/*"
  [headers.values]
    Cache-Control = "public, max-age=86400"

# Add headers for video files to ensure proper MIME types
[[headers]]
  for = "/blog/*/*.mp4"
  [headers.values]
    Content-Type = "video/mp4"
    Cache-Control = "public, max-age=86400"

[[headers]]
  for = "/blog/*/*.webm"
  [headers.values]
    Content-Type = "video/webm"
    Cache-Control = "public, max-age=86400"

[[headers]]
  for = "/blog/*/*.ogv"
  [headers.values]
    Content-Type = "video/ogg"
    Cache-Control = "public, max-age=86400"

# Add headers for audio files
[[headers]]
  for = "/blog/*/*.mp3"
  [headers.values]
    Content-Type = "audio/mpeg"
    Cache-Control = "public, max-age=86400"

[[headers]]
  for = "/blog/*/*.ogg"
  [headers.values]
    Content-Type = "audio/ogg"
    Cache-Control = "public, max-age=86400"

# Add JS MIME type headers to ensure JS files load correctly
[[headers]]
  for = "/_app/immutable/**/*.js"
  [headers.values]
    Content-Type = "application/javascript"
    Cache-Control = "public, max-age=31536000, immutable"

# Handle blog post pages with trailing slashes specifically
[[redirects]]
  from = "/blog/*/"
  to = "/blog/:splat"
  status = 301
  force = true

# SPA fallback - ensure all routes are handled
[[redirects]]
  from = "/*"
  to = "/index.html"
  status = 200
